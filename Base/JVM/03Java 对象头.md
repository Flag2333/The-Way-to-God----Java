### Java对象头

- #### 什么是对象头？

  对象头是用来存放对象除实例数据外的必要信息的，分为三个部分：

  1. 存放对象自身的运行时数据

     ​	包括：哈希码，GC分代年龄，锁状态标志，线程持有的锁，偏向线程ID，偏向时间戳等

  2. 存储指向方法区对象类型数据的指针，如果对象是数组，还有一个额外的部分用于存储数组长度。

- #### 对象头的作用？

  对象头是实现轻量级锁和偏向锁的关键。

  - ##### 轻量级锁

    - 加锁过程

      1. 在当前线程的栈帧中建立一个锁记录空间，用来存放对象头的拷贝

      2. CAS操作尝试将对象头更新为指向锁记录的指针

      3. 更新成功则加锁成功，对象头锁标志为更新为“00”（没有锁为“01”），当前为轻量级锁；

         更新失败则检查对象的对象头是否指向当前线程，如果是则直接同步，否则表示当前对象被其他线程占用，若两条以上线程争夺同一个锁，则膨胀为重量级锁“10”

    - 解锁过程

      ​	CAS把对象的对象头与线程中复制的对象头互换，互换成功则同步完成，否则表示有其他线程尝试过获取该锁，会在释放锁的同时唤起线程

    - 优缺点

      ​	在无竞争的情况下，轻量级锁效率高，有竞争的情况下会有互斥量的开销并且还会额外发生CAS操作，比传统的重量级锁更慢

  - ##### 偏向锁

    - 过程

       这个锁会偏向于第一个获得它的线程，无竞争的情况下，当前线程就无需同步了，过程如下：

    	1. 把对象头的标志位设置为“01”，即偏向模式，同时CAS把当前线程ID存在对象头的偏向线程ID中
    	2. 如果有其他线程竞争该锁，偏向模式结束，撤销偏向，之后按照轻量级锁执行

    - 优缺点

      ​	提高有同步无竞争情况下的性能，如果有多个线程同时竞争锁的话，偏向锁就没有意义了